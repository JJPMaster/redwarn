<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />

    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.blue-indigo.min.css" />
</head>

<body onload="refreshLive();">
    <!-- Show a few edits on load -->
    <!-- No header, and the drawer stays open on larger screens (fixed drawer). -->
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-drawer">

        <dialog class="mdl-dialog" id="filterSubDialog" style="width: 500px;">
            <h5 class="mdl-dialog__title" style="padding-bottom: 32px;">Filter Preferences</h5>
            <div class="mdl-dialog__content">
                <div id="filtertoggles" style="width: 50%; min-height: 350px; float: left;">
                    <p>Filter toggles</p>
                    <p>
                        <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" id="filterswitch" for="switch-1">
                            <input type="checkbox" id="switch-1" class="mdl-switch__input" checked>
                            <span class="mdl-switch__label">Autopatrolled Edits</span>
                          </label>
                        <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" id="filterswitch" for="switch-2">
                          <input type="checkbox" id="switch-2" class="mdl-switch__input" checked>
                          <span class="mdl-switch__label">Bot Edits</span>
                        </label>
                        <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" id="filterswitch" for="switch-3">
                          <input type="checkbox" id="switch-3" class="mdl-switch__input" checked>
                          <span class="mdl-switch__label">Minor Edits</span>
                        </label>
                        <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" id="filterswitch" for="switch-4">
                            <input type="checkbox" id="switch-4" class="mdl-switch__input" checked>
                            <span class="mdl-switch__label">Patrolled Edits</span>
                          </label>
                        <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" id="filterswitch" for="switch-5">
                          <input type="checkbox" id="switch-5" class="mdl-switch__input" checked>
                          <span class="mdl-switch__label">Redirect Page Edits</span>
                        </label>
                        <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" id="filterswitch" for="switch-6">
                          <input type="checkbox" id="switch-6" class="mdl-switch__input" checked>
                          <span class="mdl-switch__label">Anonymous Users</span>
                        </label>
                        <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" id="filterswitch" for="switch-7" style="margin-top: 20px !important;">
                            <input type="checkbox" id="switch-7" class="mdl-switch__input" checked>
                            <span class="mdl-switch__label">Latest revisions only</span>
                          </label>
                    </p>
                </div>
                <div id="filterspecifics" style="width: 50%; min-height: 350px; display: inline-block;">
                    <p>Specific Filters</p>
                    <select class="dropdown-rctype dropdown-sw" name="rctype[]" multiple="multiple"></select><br><br>
                    <select class="dropdown-rctag dropdown-sw" name="rcname[]"></select>
                </div>

                <div class="mdl-dialog__actions">
                    <button type="button" class="mdl-button close">Close</button>
                    <button type="button" class="mdl-button" onclick="saveConfig()">Save</button>

                </div>
            </div>
        </dialog>
        <div class="mdl-layout mdl-js-layout mdl-layout--fixed-drawer">
            <div class="mdl-layout__drawer" style="width:100%;-webkit-transform: translateX(0px); transform: translateX(0px);">
            <span class="mdl-layout-title" style="font-size: 3.5vh;">`+ rw.logoHTML +` Patrol</span>
            <div id="cornerbuttons" style="position: fixed; right: 35px; top: 15px; display: flex; justify-content: flex-end; flex-direction: row;">
                <button class="mdl-button mdl-js-button mdl-button--icon" id="filterButton" style="margin-right: 7px;">
                <i class="material-icons">settings</i>
                </button>                
                <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" id="live" for="liveswitch" style="margin-top: 3px;">
                    <input type="checkbox" id="liveswitch" class="mdl-switch__input" onclick="switchCheck()"/>
                    <span class="mdl-switch__label"><small>Toggle live</small></span>
                </label>
            </div>

            <nav class="mdl-navigation" style="width: 100%;">
                <div class="btns" style="width: 100%;">
                    <a class="mdl-navigation__link" style="width: 50%; float: left !important; margin-right: 0; padding-right: 0; margin-left:0; padding-left: 0;" onclick="window.parent.postMessage('closeDialogPT');" href="">
                        <span style="padding-left: 32px;">Return to wikipedia</span>
                    </a>
                    <a class="mdl-navigation__link" style="width: 50%; float: right !important; margin-right: 0; padding-right: 0; margin-left:0; padding-left: 0;" href="#" id="newAttached" target="_blank">
                        <span style="padding-left: 32px;">Open new attached tab</span>
                    </a>
                </div>
                <a class="mdl-navigation__link" id="hoverswitch" href="#" style="background-color: teal;color:white; display: initial;"
                    onmouseover="tI = setInterval(refreshLive,  750);"
                    onmouseout="clearTimeout(tI);">Hover your cursor here for live updates</a>
                <div id="recentChangesContainer">
                    <!--\/ PLACEHOLDER VALUE FOR FORMATTING REMOVE ON REV15 BUILD FINISH \/-->
                    <div id="43254543544643643632532423523235" class="child__edit" style="height: 150px; background-color: crimson; padding-left: 32px">
                        <div id="actions" style="padding-bottom: 5px; padding-top: 5px;">
                            <a class="mdl-button mdl-js-button mdl-button--icon">
                                <i class="material-icons">
                                    open_in_browser
                                </i>
                            </a>
                            <a class="mdl-button mdl-js-button mdl-button--icon">
                                <i class="material-icons">
                                    compare
                                </i>
                            </a>
                            <a class="mdl-button mdl-js-button mdl-button--icon">
                                <i class="material-icons">
                                    send
                                </i>
                            </a>
                        </div>
                        <p class="userinfo">User • (Edits) • Warnings</p>
                        <p class="slightly-larger">[Type]: [Page] (+XXXX) (ICN)</p>
                        <p>Comment: Lorem Ipsum Domen...</p>
                        <small class="btm-right">Tags: X, Y, Z</small>
                    </div>
                    <!--/\ PLACEHOLDER VALUE FOR FORMATTING REMOVE ON REV15 BUILD FINISH /\-->
                </div>
            </nav>
            </div>
        </div>

        <main class="mdl-layout__content">
            <div class="page-content" style="display:none;">
            </div>
        </main>
    </div>
    <style>
        .userinfo {
            padding-top: 5px;
            display: inline-flex;
            vertical-align: middle !important;
        }
        .btm-right small {
            bottom: 15px;
            right: 20px;
        }
        .child__edit {
            height: 160px;
            max-height: 200px;
            padding-left: 32px;
            border-top: 1px solid grey;
        }
        .child__edit p {
            margin: 0 0 0 0;
            font-size: medium;
        }
        .dropdown-sw {
            width: 200px;
        }
        .mdl-navigation__link {
            text-decoration: none;
            font-size: 14px;
            font-weight: 400;
            line-height: 24px;
            letter-spacing: 0;
            opacity: .87;
        }

        #filterswitch {
            margin-bottom: 15px;
        }

        .mdl-dialog__content {
            width: 100%;
            padding: 0;
            margin: auto;
        }
        .select2-dropdown.increasezindex {
            z-index:999999999999; /* ITS OVER 9000 LOOOL */
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script>



        // Defining constants
        const WIKICWD = "https:" + "`+ rw.wikiBase +`";
        const WIKIID = "`+ rw.wikiID +`";
        const WIKIAPI = "` +rw.wikiAPI +`";
        
        var rctypes = ["Categorize", "Edit", "External", "Log", "New"];
        var rctags = ["Possible Vandalism", "Bad External Link/Image(s)", "Replaces >90% of page", "Undo", "Rollback", "New Redirect", "Possible BLP issue or vandalism", "Remove redirect", "Blanking", "Possible autobiography", ]; // Should be a list of commonly used tags or the default tag (from config), which should be put into the place of rctags[0]
        $(document).ready(function() {
            $('.dropdown-rctype').select2({
                placeholder: "rctype",
                multiple: true,
                tags: false,
                data: rctypes,
                allowClear: true,
                dropdownCssClass:'increasezindex'
            });
            $('.dropdown-rctag').select2({
                placeholder: "rctag",
                multiple: true,
                tags: true,
                data: rctags,
                allowClear: true,
                dropdownCssClass:'increasezindex'
            });
        });
        $(document).ready(function() {
            saveConfig();
        });

        Array.prototype.remove = function(value) { // fuck you internet explorer u kinda smell
                    for (var i = this.length; i--; ) {
                        if (this[i] === value) {
                            this.splice(i, 1);
                        }
                    }
                }

        function fetchEditCount(ids, callback) {
            let idurl = "";
            ids.forEach(element => { 
                idurl += element + "|";
            });            
            idurl = idurl.substring(0, idurl.length - 1); //remove last char (which will be an excess "|")
            $.getJSON(WIKICWD + "/w/api.php?action=query&list=users&ususerids="+ idurl + "&format=json&usprop=editcount", feed => {
                callback(feed)
            });
        }

        function getUserInfo(ids, callback) { // ids should be an array of user ids - will return EDIT COUNT (API:Users) and WARNING LEVEL (Unoffical)
            fetchEditCount(ids, result => {
                let infoOUT = []; // Nested array - output of output[n][0] is userid & output[n][1] is corresponding edit count & output[n][2] is warning level
                let user = result.query.users;
                let unamelist = [];
                user.forEach(value => { // to make stuff for lastwarninglevel
                    unamelist.push(value.name);
                });
                user.forEach(user => {
                    let userInfo = [];
                    userInfo = [user.userid, user.name, user.editcount];
                    infoOUT.push({uid: userInfo[0], name: userInfo[1], editcount: userInfo[2]}); // push everything out to callback array
                });
                callback(infoOUT); // it is done.
            });
        }


        function getRndInteger(max) { // its in the name
              return Math.floor(Math.random() * Math.floor(max));
        }

        function refreshLiveTMP() {
            // if you add to it its preferred you refer to a users id when referring to an edit, as names are not as consistent (anons are given a random value).
            // insert code for filter fetch here
            var filterlist = ["filters"];
            let enableWarn = true; // temp
            fetchRecentChanges(filterlist, call => { // send filterlist to parserecentchanges to filter out stuff then use callback func. to handle parsing etc...
                let container = document.getElementById('recentChangesContainer');
                let ids = []; 
                let allRevs = []; // didnt realise till towards the end that using userid as your identifying id is a bad idea.
                let allIDS = []; // Maintain relationship between our anon- and the username (which will be the IP adress of the person)
                let allUSERS_only = []; // for lastwarninglvl
                let allANON = [];
                
                let unanonLIST = []; // for calling stuff that needs NONANONYMOUS USERS
                for(let [key, value] of Object.entries(call)) {
                    unanonLIST.push(value.userid);
                }
                for(let [key, value] of Object.entries(call)) { // Get the values to link the things up to eachother
                    if(value.userid == 0 ) {
                        value.userid = "anon-" + getRndInteger(999999999);
                        allANON.push([value.userid, value.user]);
                    } else {
                        allUSERS_only.push(value.user);
                    }
                    let ptLogRevTMP = {revid: value.revid, old_revid: value.old_revid, uid: value.userid, uname: value.user, title: value.title, comment: value.parsedcomment, tags: value.tags, type: value.type, size_old: value.oldlen, size_new: value.newlen};
                    let linkIDUN = [value.userid, value.user]; // Solve issues with username - anon-[no] relationship, anons have id of 0 so we need to make sure usernames are linked back to anons
                    ids.push((value.userid).toString());
                    allIDS.push(linkIDUN);
                    allRevs.push(ptLogRevTMP);
                }

                
                allRevs.forEach(arr => { // arr[0] is rev name arr[2] is userid of the editor, makes divs for stuff
                    let iter = arr.uname;
                    let userid = arr.uid;
                    let revid = arr.revid
                    allIDS.forEach(uID => { // link stuff (anons)
                        if (iter == uID[1]) {
                            userid = uID[0];
                        }
                    });
                    container.innerHTML += "<div class='child__edit " + userid + " " + arr.uname + " " + revid + "' style='background-color: green;'><div id='actions' style='padding-bottom: 5px; padding-top: 5px;'><a class='mdl-button mdl-js-button mdl-button--icon'><i class='material-icons'>open_in_browser</i></a><a class='mdl-button mdl-js-button mdl-button--icon'><i class='material-icons'>compare</i></a><a class='mdl-button mdl-js-button mdl-button--icon'><i class='material-icons'>send</i></a></div></div>"
                });

                let infoOUT = []; // Nested array - output of output[n][0] is userid & output[n][1] is corresponding edit count & output[n][2] is warning level
                getUserInfo(unanonLIST, userinfo => { // usernames parameter is used for consistency of anon
                    // IDENTIFIABLE ISSUE: WE DO NOT HAVE A RESULT FROM THE THING
                    let unamelist =[];
                    userinfo.forEach(res => {
                        let uname = res.name;
                        let editcount = res.editcount;
                        let warningLvl = res.warninglevel;
                        if(res.name == uname) {
                            let warningLevelIcn;
                            // horror for setting icn
                            $("." + res.uid).append("<p class='userinfo'>" + uname + " • (" + editcount + ") • <span class='warningLevel warn-" + res.uid +"'> <span class='material-icons'>autorenew</span></span></p>")
                        };
                    });
                    allANON.forEach(arr => {
                        $("." + arr[0]).append("<p class='userinfo'>" + arr[1] + " • (N/A) • <span class='warningLevel warn-" + arr[0] +"'> <span class='material-icons'>close</span></span></p>")
                    });
                    allRevs.forEach(arr => {
                        if(arr.comment == "") {
                            arr.comment = "(No comment provided.)"
                        }
                        let trafficIcn;
                        let size = arr.size_new - arr.size_old;
                        let sizeStr = "";
                        if(size < 0) {
                            sizeStr = size.toString();
                        } else {
                            sizeStr = "+" + size.toString();
                        }
                        $("." + arr.revid).append("<p class='slightly-larger'>[" + capitalizeFirstLetter(arr.type) +"]: " + arr.title + "   ("+ sizeStr +") <span class='trafficlight-'" + arr.revid + ")</p><p>Comment: " + arr.comment + "</p><small class='btm-right'>Tags: <span class='tags-"+ arr.revid + "'></span></small>");
                        var tags = arr.tags;
                        let tagsToAppend = "";
                        tags.forEach(tag => {
                            console.log(tag)
                            tagsToAppend += tag + ", ";
                        })
                        if(tagsToAppend.length == 0) {
                            tagsToAppend = "None."
                        } else {
                            tagsToAppend.slice(0, -2);
                        }
                        $(".tags-" + arr.revid).append(tagsToAppend);
                    });
                    lastWarningLevel(allUSERS_only, warnArr => {
                        // ...
                        warnArr.forEach(value => {
                            let warningLevelIcn;
                            let name = value[0]
                            if (value[1] == "0") {
                                warningLevelIcn = "thumb_up" // no change
                            } else if (value[1] == "1") {
                                warningLevelIcn = "info";
                            } else if (value[1] == "2") {
                                warningLevelIcn = "announcement";
                            } else if (value[1] == "3") {
                                warningLevelIcn = "report_problem";
                            } else if (value[1] == "4") {
                                warningLevelIcn == "report";
                            } else if (value[1] == undefined) {
                                warningLevelIcn == "thumb_up"; // is anonymous user/no warning level out given
                            }
                            let uid; 
                            allIDS.forEach(userARR => {
                                if(userARR[1] == name) {
                                    uid = userARR[0];
                                }
                            $(".warn-" + uid).html("<span class='material-icons' style='padding-left: 5px;'>"+ warningLevelIcn +"</span>");
                            });
                        })
                    });
                });

            });
        }

        refreshLiveTMP();

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        function switchCheck() { // Checks on the switch click for toggling live feeds if its in 'checked' state or not and changes page accordingly
            let livetoggle= document.getElementById('liveswitch');
            let hoverswitch = document.getElementById('hoverswitch');
            if (livetoggle.checked == true) {
                tI = setInterval(refreshLive, 750);
                hoverswitch.style.display = "none";
            } else {
                clearTimeout(tI);
                hoverswitch.style.display = "initial";
            }
        }


        // code for filters preferences
        var filterButton = document.getElementById('filterButton');
        var filterDialog = document.getElementById('filterSubDialog');

        if (!filterDialog.showModal) {
            dialogPolyfill.registerDialog(filterDialog);
        }
        filterButton.addEventListener('click', function () {
            filterDialog.showModal();
        })
        filterDialog.querySelector('.close').addEventListener('click', function () {
            filterDialog.close();
        });
        // code for filters preferences


        // Create broadcast channel
        var bcID = "RWBC_" + Math.random().toString(36).substring(7);
        const bc = new BroadcastChannel(bcID);
        $("#newAttached").attr("href", "https://en.wikipedia.org/wiki/User:Ed6767/redwarn/patrol#rwPatrolAttach-" + bcID); // set link

        var tI;
        function convertRange(value, r1, r2) {
            return (value - r1[0]) * (r2[1] - r2[0]) / (r1[1] - r1[0]) + r2[0];
        }



        function goToLatestDiffPage(article) {
            $("#welcomeContainer").hide();
            // Nav to latest diff page
            $.getJSON(WIKICWD + "/w/api.php?action=query&prop=revisions&titles=" + encodeURIComponent(article) + "&rvslots=*&rvprop=ids%7Cuser&formatversion=2&format=json", r => {
                // We got the response
                let latestRId = r.query.pages[0].revisions[0].revid;
                let parentRId = r.query.pages[0].revisions[0].parentid;
                // Open page in new tab (has to be done here due to new security systems)
                bc.postMessage(WIKICWD + "/w/index.php?title=" + encodeURIComponent(name) + "&diff=" + latestRId + "&oldid=" + parentRId + "&diffmode=source");
            });
        }

        function fetchRecentChanges(filterlist, callback) { // fetch JSON from action API using querys
            $.getJSON(WIKICWD + "/w/api.php?action=query&list=recentchanges&rclimit=50&format=json&rcprop=user|userid|title|timestamp|ids|tags|parsedcomment|sizes&rctype=edit|external|new", r => { // we need to add stuff for filters in here somewhere later.
                let feed = r.query.recentchanges;
                callback(feed); // this is all we needed to do
                });
        }
        
        function saveConfig() {
            var rctypefilter = $('.dropdown-rctype').select2('data');
            var rctagfilter = $('.dropdown-rctag').select2('data');
            var switch2 = document.getElementById('switch-2').checked;
        }




        function fetchMeWarningLevel(users, callback) { // death
            let userurl = "";
            users.forEach(value => {
                if(value == undefined) {
                    return true;
                }
                userurl += "User_talk:" + value + "|";
            });
            userurl = userurl.substring(0, userurl.length - 1);
            // Get the last warning level of a user this month
            $.getJSON(WIKICWD + "/w/api.php?action=query&prop=revisions&titles="+ userurl +"&rvslots=*&rvprop=content&formatversion=2&format=json", feed => {
            // ...
                callback(feed)
            });

        }

        function lastWarningLevel(users, callback) { // callback() - users param is an array!
        // users should be ARRAY
            fetchMeWarningLevel(users, phoneafriend => { // returns feed for us to use, users is parsed within function 
                var warnsOUT = [];
                phoneafriend.query.pages.forEach(value => {
                    //...
                    let perUserWarns = [];
                    let username = (value.title).substring(10); // Put username in place so we can figure out what goes where
                    perUserWarns.push(username); 
                    if (!value.missing) {
                        content = value.revisions[0].slots.main.content; // load page content into var if talk page exists
                    } else {
                        perUserWarns.push('0') // return 0, missing talk page
                        warnsOUT.push(perUserWarns); // since it finished we should push to output now
                        return true; // begin next $.each loop iteration returning true to callback
                    }
                    let contentLines = content.split("\\n");

                    // date heading
                    let currentDateHeading = ((d)=>{return "== " + ['January','February','March','April','May','June','July','August','September','October','November','December'][d.getMonth()] + " " + (1900 + d.getYear()) + " =="})(new Date);
                    // date heading no space (rev13)
                    let currentAltDateHeading = ((d)=>{return "==" + ['January','February','March','April','May','June','July','August','September','October','November','December'][d.getMonth()] + " " + (1900 + d.getYear()) + "=="})(new Date);
                    
                    let pagesIncludeCurrentDate = contentLines.includes(currentDateHeading);
                    let pagesIncludeCurrentAltDate = contentLines.includes(currentAltDateHeading);

                    if ((!pagesIncludeCurrentDate) && (!pagesIncludeCurrentAltDate)) {
                        perUserWarns.push('0'); // no warnings this month
                        warnsOUT.push(perUserWarns);
                        return true; // begin next iteration
                    } else if ((!pagesIncludeCurrentDate) && (pagesIncludeCurrentAltDate)) { currentDateHeading = currentAltDateHeading; }
                    // Aft determining if page exists or if using alt date, continue onwards
                    let highestWarningLevel = 0; // Highest is 0 so if d/t with nothing inside report this
                    let thisMonthsNotices = "" // for dialog
                    for(let i = contentLines.indexOf(currentDateHeading) + 1; i < contentLines.length; i++) { // For each line
                        if (contentLines[i].startsWith("==")) {
                            break; // New section so break loop - Level 0 Warning / N/A
                        }

                        if (contentLines[i].match(/(File:|Image:)Stop hand nuvola.svg/gi)) { // Set to level 4
                            highestWarningLevel = 4;
                            break; // Is highest dont need to check more, break
                        }

                        if (contentLines[i].match(/(File:|Image:)(Nuvola apps important.svg|Ambox warning pn.svg)/gi)) { // Set to level 4
                            highestWarningLevel = 3;
                        }

                        if (contentLines[i].match(/(File:|Image:)Information orange.svg/gi)) { // Set to level 2
                            if (highestWarningLevel < 3) { // Check isnt higher
                                highestWarningLevel = 2;
                            }
                        }

                        if (contentLines[i].match(/(File:|Image:)Information.svg/gi)) { // Set to level 1
                            if (highestWarningLevel < 2) { // Check isnt higher
                                highestWarningLevel = 1;
                            }
                        }
                        // ... if you need anything extra within the inspect loop
                    }
                    perUserWarns.push(highestWarningLevel.toString());
                    warnsOUT.push(perUserWarns);

                    // ... anything outside the inspect loop ie: pushing to warnsOUT

                });
                //  ... anything outside MAIN loop ie calling back warnsout final
                console.log(warnsOUT);
                callback(warnsOUT);
                return;
            })
        }
        //lastWarningLevel(["Ed6767", "Prompt0259"], res => {
        //    console.log(res)ge
        //    alert(res.length)
        //})

        function refreshLive() {
            console.log("Placeholder.")
        }



    </script>
</body>

</html>